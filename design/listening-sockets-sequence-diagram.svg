<?xml version="1.0" encoding="UTF-8"?>
<svg width="900" height="550" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <!-- Define gradients and styles -->
    <linearGradient id="actorGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#fff3e0;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#ffcc02;stop-opacity:1" />
    </linearGradient>
    <linearGradient id="messageGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#e8f5e8;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#c8e6c8;stop-opacity:1" />
    </linearGradient>
    
    <!-- Arrow markers -->
    <marker id="arrowhead" markerWidth="10" markerHeight="7" 
            refX="0" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333" />
    </marker>
    <marker id="returnarrow" markerWidth="10" markerHeight="7" 
            refX="10" refY="3.5" orient="auto">
      <polygon points="0 3.5, 10 0, 10 7" fill="#666" />
    </marker>
  </defs>
  
  <!-- Title -->
  <text x="450" y="30" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="20" font-weight="bold" fill="#f57f17">
    Listening Sockets Processing Pipeline - Sequence Diagram
  </text>
  
  <!-- Actors -->
  <!-- CLI -->
  <rect x="80" y="60" width="100" height="50" rx="8" fill="url(#actorGrad)" 
        stroke="#f57c00" stroke-width="2"/>
  <text x="130" y="80" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="12" font-weight="bold" fill="#e65100">CLI</text>
  <text x="130" y="95" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="9" fill="#424242">Command Handler</text>
  
  <!-- Check -->
  <rect x="250" y="60" width="120" height="50" rx="8" fill="url(#actorGrad)" 
        stroke="#f57c00" stroke-width="2"/>
  <text x="310" y="80" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="12" font-weight="bold" fill="#e65100">Check</text>
  <text x="310" y="95" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="9" fill="#424242">Connection Check</text>
  
  <!-- Utils -->
  <rect x="430" y="60" width="120" height="50" rx="8" fill="url(#actorGrad)" 
        stroke="#f57c00" stroke-width="2"/>
  <text x="490" y="80" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="12" font-weight="bold" fill="#e65100">Utils</text>
  <text x="490" y="95" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="9" fill="#424242">Utility Interface</text>
  
  <!-- Node -->
  <rect x="620" y="60" width="120" height="50" rx="8" fill="url(#actorGrad)" 
        stroke="#f57c00" stroke-width="2"/>
  <text x="680" y="80" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="12" font-weight="bold" fill="#e65100">Node</text>
  <text x="680" y="95" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="9" fill="#424242">Cluster Node</text>
  
  <!-- Lifelines -->
  <line x1="130" y1="110" x2="130" y2="500" stroke="#ddd" stroke-width="3" stroke-dasharray="8,4"/>
  <line x1="310" y1="110" x2="310" y2="500" stroke="#ddd" stroke-width="3" stroke-dasharray="8,4"/>
  <line x1="490" y1="110" x2="490" y2="500" stroke="#ddd" stroke-width="3" stroke-dasharray="8,4"/>
  <line x1="680" y1="110" x2="680" y2="500" stroke="#ddd" stroke-width="3" stroke-dasharray="8,4"/>
  
  <!-- Messages -->
  
  <!-- 1. CLI to Check: GenerateSS() -->
  <line x1="130" y1="140" x2="310" y2="140" stroke="#388e3c" stroke-width="3" marker-end="url(#arrowhead)"/>
  <rect x="180" y="125" width="100" height="20" fill="url(#messageGrad)" stroke="#2e7d32" rx="4"/>
  <text x="230" y="137" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" font-weight="bold" fill="#1b5e20">GenerateSS()</text>
  
  <!-- 2. Check to Utils: CreatePodOnNode() -->
  <line x1="310" y1="170" x2="490" y2="170" stroke="#388e3c" stroke-width="3" marker-end="url(#arrowhead)"/>
  <rect x="360" y="155" width="120" height="20" fill="url(#messageGrad)" stroke="#2e7d32" rx="4"/>
  <text x="420" y="167" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" font-weight="bold" fill="#1b5e20">CreatePodOnNode()</text>
  
  <!-- 3. Utils to Check: Debug Pod (return) -->
  <line x1="490" y1="200" x2="310" y2="200" stroke="#795548" stroke-width="3" marker-end="url(#returnarrow)" stroke-dasharray="10,5"/>
  <rect x="370" y="185" width="80" height="20" fill="#fff3e0" stroke="#ff8f00" rx="4"/>
  <text x="410" y="197" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" fill="#ef6c00">Debug Pod</text>
  
  <!-- 4. Check to Utils: RunCommandOnPod("ss -anpltH") -->
  <line x1="310" y1="230" x2="490" y2="230" stroke="#388e3c" stroke-width="3" marker-end="url(#arrowhead)"/>
  <rect x="320" y="215" width="160" height="20" fill="url(#messageGrad)" stroke="#2e7d32" rx="4"/>
  <text x="400" y="227" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="10" font-weight="bold" fill="#1b5e20">RunCommandOnPod("ss -anpltH")</text>
  
  <!-- 5. Utils to Check: TCP Socket Data (return) -->
  <line x1="490" y1="260" x2="310" y2="260" stroke="#795548" stroke-width="3" marker-end="url(#returnarrow)" stroke-dasharray="10,5"/>
  <rect x="355" y="245" width="110" height="20" fill="#fff3e0" stroke="#ff8f00" rx="4"/>
  <text x="410" y="257" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" fill="#ef6c00">TCP Socket Data</text>
  
  <!-- 6. Check to Utils: RunCommandOnPod("ss -anpluH") -->
  <line x1="310" y1="290" x2="490" y2="290" stroke="#388e3c" stroke-width="3" marker-end="url(#arrowhead)"/>
  <rect x="320" y="275" width="160" height="20" fill="url(#messageGrad)" stroke="#2e7d32" rx="4"/>
  <text x="400" y="287" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="10" font-weight="bold" fill="#1b5e20">RunCommandOnPod("ss -anpluH")</text>
  
  <!-- 7. Utils to Check: UDP Socket Data (return) -->
  <line x1="490" y1="320" x2="310" y2="320" stroke="#795548" stroke-width="3" marker-end="url(#returnarrow)" stroke-dasharray="10,5"/>
  <rect x="355" y="305" width="110" height="20" fill="#fff3e0" stroke="#ff8f00" rx="4"/>
  <text x="410" y="317" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" fill="#ef6c00">UDP Socket Data</text>
  
  <!-- 8. Check self: Process Socket Data -->
  <line x1="310" y1="350" x2="360" y2="350" stroke="#1565c0" stroke-width="3"/>
  <line x1="360" y1="350" x2="360" y2="380" stroke="#1565c0" stroke-width="3"/>
  <line x1="360" y1="380" x2="310" y2="380" stroke="#1565c0" stroke-width="3" marker-end="url(#arrowhead)"/>
  <rect x="370" y="360" width="130" height="25" fill="#e3f2fd" stroke="#1976d2" rx="4"/>
  <text x="435" y="370" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="10" font-weight="bold" fill="#0d47a1">Process Socket Data</text>
  <text x="435" y="382" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="8" fill="#1565c0">Parse &amp; Map to Containers</text>
  
  <!-- 9. Check to Utils: DeletePod() -->
  <line x1="310" y1="410" x2="490" y2="410" stroke="#388e3c" stroke-width="3" marker-end="url(#arrowhead)"/>
  <rect x="370" y="395" width="90" height="20" fill="url(#messageGrad)" stroke="#2e7d32" rx="4"/>
  <text x="415" y="407" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" font-weight="bold" fill="#1b5e20">DeletePod()</text>
  
  <!-- 10. Check to CLI: ComMatrix + Raw Data (return) -->
  <line x1="310" y1="450" x2="130" y2="450" stroke="#795548" stroke-width="3" marker-end="url(#returnarrow)" stroke-dasharray="10,5"/>
  <rect x="160" y="435" width="140" height="20" fill="#e8f5e8" stroke="#4caf50" rx="4"/>
  <text x="230" y="447" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" font-weight="bold" fill="#2e7d32">ComMatrix + Raw Data</text>
  
  <!-- Processing Note Box -->
  <rect x="520" y="180" width="170" height="120" rx="8" fill="#f3e5f5" stroke="#9c27b0" stroke-width="2" stroke-dasharray="8,4"/>
  <text x="605" y="200" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="12" font-weight="bold" fill="#6a1b9a">Processing Details</text>
  <text x="530" y="220" font-family="Arial, sans-serif" font-size="9" fill="#4a148c">• Deploys privileged debug pods</text>
  <text x="530" y="235" font-family="Arial, sans-serif" font-size="9" fill="#4a148c">• Executes ss commands on nodes</text>
  <text x="530" y="250" font-family="Arial, sans-serif" font-size="9" fill="#4a148c">• Extracts PID from socket output</text>
  <text x="530" y="265" font-family="Arial, sans-serif" font-size="9" fill="#4a148c">• Maps processes to containers</text>
  <text x="530" y="280" font-family="Arial, sans-serif" font-size="9" fill="#4a148c">• Uses crictl for container info</text>
  <text x="530" y="295" font-family="Arial, sans-serif" font-size="9" fill="#4a148c">• Cleans up debug resources</text>
  
  <!-- Host Commands Info -->
  <rect x="50" y="350" width="200" height="80" rx="6" fill="#fff8e1" stroke="#ffc107" stroke-width="2"/>
  <text x="150" y="370" text-anchor="middle" font-family="Arial, sans-serif" 
        font-size="11" font-weight="bold" fill="#f57c00">Host Commands</text>
  <text x="60" y="390" font-family="Arial, sans-serif" font-size="10" fill="#e65100">ss -anpltH (TCP sockets)</text>
  <text x="60" y="405" font-family="Arial, sans-serif" font-size="10" fill="#e65100">ss -anpluH (UDP sockets)</text>
  <text x="60" y="420" font-family="Arial, sans-serif" font-size="9" fill="#ff8f00">Executed on each cluster node</text>
  
  <!-- Legend -->
  <rect x="50" y="520" width="800" height="25" rx="3" fill="#f8f9fa" stroke="#dee2e6"/>
  <text x="60" y="535" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="#495057">Legend:</text>
  
  <line x1="130" y1="532" x2="160" y2="532" stroke="#388e3c" stroke-width="3" marker-end="url(#arrowhead)"/>
  <text x="165" y="535" font-family="Arial, sans-serif" font-size="10" fill="#495057">Method Call</text>
  
  <line x1="250" y1="532" x2="280" y2="532" stroke="#795548" stroke-width="3" marker-end="url(#returnarrow)" stroke-dasharray="10,5"/>
  <text x="285" y="535" font-family="Arial, sans-serif" font-size="10" fill="#495057">Return Value</text>
  
  <line x1="380" y1="530" x2="400" y2="530" stroke="#1565c0" stroke-width="3"/>
  <line x1="400" y1="530" x2="400" y2="534" stroke="#1565c0" stroke-width="3"/>
  <line x1="400" y1="534" x2="380" y2="534" stroke="#1565c0" stroke-width="3"/>
  <text x="405" y="535" font-family="Arial, sans-serif" font-size="10" fill="#495057">Self Processing</text>
  
  <text x="520" y="535" font-family="Arial, sans-serif" font-size="10" fill="#495057">| Host-level socket analysis executed in parallel across all cluster nodes</text>
</svg>
